[//]: # (# 🎉 阿里云短信服务集成完成)

[//]: # ()
[//]: # (## ✅ 已完成的工作)

[//]: # ()
[//]: # (### 1. 代码迁移)

[//]: # ()
[//]: # (#### 📝 修改的文件)

[//]: # ()
[//]: # (1. **`utils/sms_util.go`** ✅)

[//]: # (   - 移除腾讯云 `TencentSMSClient`)

[//]: # (   - 新增阿里云 `AliyunSMSClient`)

[//]: # (   - 实现阿里云短信发送逻辑)

[//]: # (   - 完整的错误处理和日志记录)

[//]: # ()
[//]: # (2. **`service/sms_service.go`** ✅)

[//]: # (   - 更新客户端引用：`TencentSMSClient` → `AliyunSMSClient`)

[//]: # (   - 更新环境变量：`TENCENT_SMS_*` → `ALIYUN_SMS_*`)

[//]: # (   - 保持原有业务逻辑不变)

[//]: # ()
[//]: # (3. **`go.mod`** ✅)

[//]: # (   - 移除腾讯云SDK依赖)

[//]: # (   - 添加阿里云SDK依赖：)

[//]: # (     - `github.com/alibabacloud-go/dypnsapi-20170525/v3`)

[//]: # (     - `github.com/alibabacloud-go/darabonba-openapi/v2`)

[//]: # (     - `github.com/alibabacloud-go/tea`)

[//]: # (     - `github.com/alibabacloud-go/tea-utils/v2`)

[//]: # (     - `github.com/aliyun/credentials-go`)

[//]: # ()
[//]: # (4. **`.env.example`** ✅)

[//]: # (   - 更新环境变量配置说明)

[//]: # (   - 添加阿里云凭证配置)

[//]: # (   - 添加短信签名和模板配置)

[//]: # ()
[//]: # (#### 📄 新增的文件)

[//]: # ()
[//]: # (1. **`ALIYUN_SMS_MIGRATION.md`** ✅)

[//]: # (   - 完整的迁移指南)

[//]: # (   - 配置步骤说明)

[//]: # (   - 测试验证方法)

[//]: # (   - 常见问题解答)

[//]: # ()
[//]: # (2. **`install_aliyun_sms.sh`** ✅)

[//]: # (   - 自动安装依赖脚本)

[//]: # (   - 一键安装所有阿里云SDK)

[//]: # ()
[//]: # (3. **`test_aliyun_sms.sh`** ✅)

[//]: # (   - 自动化测试脚本)

[//]: # (   - 测试所有短信发送接口)

[//]: # ()
[//]: # (4. **`ALIYUN_SMS_SUMMARY.md`** ✅（本文件）)

[//]: # (   - 迁移工作总结)

[//]: # (   - 快速开始指南)

[//]: # ()
[//]: # (---)

[//]: # ()
[//]: # (## 🚀 快速开始)

[//]: # ()
[//]: # (### 第一步：安装依赖)

[//]: # ()
[//]: # (```bash)

[//]: # (cd /Users/sylvainyang/project/elysia/elysia-backend)

[//]: # ()
[//]: # (# 方式一：使用自动安装脚本（推荐）)

[//]: # (chmod +x install_aliyun_sms.sh)

[//]: # (./install_aliyun_sms.sh)

[//]: # ()
[//]: # (# 方式二：手动安装)

[//]: # (go mod tidy)

[//]: # (```)

[//]: # ()
[//]: # (### 第二步：配置环境变量)

[//]: # ()
[//]: # (编辑 `.env` 文件，添加以下配置：)

[//]: # ()
[//]: # (```bash)

[//]: # (# 阿里云AccessKey（必填）)

[//]: # (ALIBABA_CLOUD_ACCESS_KEY_ID=your-access-key-id)

[//]: # (ALIBABA_CLOUD_ACCESS_KEY_SECRET=your-access-key-secret)

[//]: # ()
[//]: # (# 短信签名（必填）)

[//]: # (ALIYUN_SMS_SIGN_NAME=速通互联验证码)

[//]: # ()
[//]: # (# 短信模板CODE（必填）)

[//]: # (ALIYUN_SMS_TEMPLATE_CODE=100001)

[//]: # (```)

[//]: # ()
[//]: # (**获取阿里云凭证：**)

[//]: # (1. 登录 [阿里云RAM控制台]&#40;https://ram.console.aliyun.com/&#41;)

[//]: # (2. 创建用户并生成 AccessKey)

[//]: # (3. 授予用户 `AliyunDypnsFullAccess` 权限)

[//]: # ()
[//]: # (**配置短信模板：**)

[//]: # (1. 登录 [阿里云短信服务控制台]&#40;https://dysms.console.aliyun.com/&#41;)

[//]: # (2. 创建签名：`速通互联验证码`)

[//]: # (3. 创建模板：`您的验证码是${code}，${min}分钟内有效。`)

[//]: # ()
[//]: # (### 第三步：编译运行)

[//]: # ()
[//]: # (```bash)

[//]: # (# 编译项目)

[//]: # (go build -o elysia-backend)

[//]: # ()
[//]: # (# 运行服务)

[//]: # (./elysia-backend)

[//]: # (```)

[//]: # ()
[//]: # (### 第四步：测试验证)

[//]: # ()
[//]: # (```bash)

[//]: # (# 使用自动化测试脚本)

[//]: # (chmod +x test_aliyun_sms.sh)

[//]: # (./test_aliyun_sms.sh)

[//]: # ()
[//]: # (# 或手动测试单个接口)

[//]: # (curl -X POST http://localhost:8001/api/student/auth/send-register-code \)

[//]: # (  -H "Content-Type: application/json" \)

[//]: # (  -d '{"phone_number": "18873197041"}')

[//]: # (```)

[//]: # ()
[//]: # (---)

[//]: # ()
[//]: # (## 📋 支持的功能)

[//]: # ()
[//]: # (### 学生端 👨‍🎓)

[//]: # (- ✅ 注册验证码：`POST /api/student/auth/send-register-code`)

[//]: # (- ✅ 登录验证码：`POST /api/student/auth/send-login-code`)

[//]: # ()
[//]: # (### 教师端 👨‍🏫)

[//]: # (- ✅ 注册验证码：`POST /api/teacher/auth/send-register-code`)

[//]: # (- ✅ 登录验证码：`POST /api/teacher/auth/send-login-code`)

[//]: # ()
[//]: # (### 管理员端 👨‍💼)

[//]: # (- ✅ 登录验证码：`POST /api/admin/auth/send-login-code`)

[//]: # ()
[//]: # (### 通用功能)

[//]: # (- ✅ 验证码生成（6位数字）)

[//]: # (- ✅ 验证码有效期（5分钟）)

[//]: # (- ✅ 发送频率限制（60秒/次）)

[//]: # (- ✅ 手机号格式验证)

[//]: # (- ✅ 用户存在性检查)

[//]: # (- ✅ 完整的错误处理)

[//]: # (- ✅ Redis缓存管理)

[//]: # ()
[//]: # (---)

[//]: # ()
[//]: # (## 🔧 技术实现)

[//]: # ()
[//]: # (### 核心代码结构)

[//]: # ()
[//]: # (```go)

[//]: # (// AliyunSMSClient 阿里云短信客户端)

[//]: # (type AliyunSMSClient struct {)

[//]: # (    client *dypnsapi20170525.Client)

[//]: # (})

[//]: # ()
[//]: # (// 发送验证码)

[//]: # (func &#40;c *AliyunSMSClient&#41; SendVerificationCode&#40;)

[//]: # (    phoneNumber, code, templateCode string)

[//]: # (&#41; error {)

[//]: # (    // 1. 获取签名)

[//]: # (    signName := os.Getenv&#40;"ALIYUN_SMS_SIGN_NAME"&#41;)

[//]: # (    )
[//]: # (    // 2. 构建模板参数)

[//]: # (    templateParam := fmt.Sprintf&#40;`{"code":"%s","min":"5"}`, code&#41;)

[//]: # (    )
[//]: # (    // 3. 创建请求)

[//]: # (    request := &dypnsapi20170525.SendSmsVerifyCodeRequest{)

[//]: # (        SignName:      tea.String&#40;signName&#41;,)

[//]: # (        TemplateCode:  tea.String&#40;templateCode&#41;,)

[//]: # (        PhoneNumber:   tea.String&#40;phoneNumber&#41;,)

[//]: # (        TemplateParam: tea.String&#40;templateParam&#41;,)

[//]: # (    })

[//]: # (    )
[//]: # (    // 4. 发送短信)

[//]: # (    resp, err := c.client.SendSmsVerifyCodeWithOptions&#40;request, runtime&#41;)

[//]: # (    )
[//]: # (    // 5. 错误处理)

[//]: # (    // ...)

[//]: # (    )
[//]: # (    return nil)

[//]: # (})

[//]: # (```)

[//]: # ()
[//]: # (### 业务流程)

[//]: # ()
[//]: # (```)

[//]: # (用户请求发送验证码)

[//]: # (    ↓)

[//]: # (参数校验（手机号、用户类型等）)

[//]: # (    ↓)

[//]: # (检查发送频率（60秒限制）)

[//]: # (    ↓)

[//]: # (检查用户存在性)

[//]: # (    ↓)

[//]: # (生成6位数字验证码)

[//]: # (    ↓)

[//]: # (保存到Redis（5分钟有效期）)

[//]: # (    ↓)

[//]: # (调用阿里云API发送短信)

[//]: # (    ↓)

[//]: # (发送成功 → 返回成功响应)

[//]: # (发送失败 → 删除Redis验证码 → 返回错误)

[//]: # (```)

[//]: # ()
[//]: # (---)

[//]: # ()
[//]: # (## 🔐 安全特性)

[//]: # ()
[//]: # (### 1. 凭证管理)

[//]: # (- ✅ 支持环境变量配置)

[//]: # (- ✅ 支持配置文件管理)

[//]: # (- ✅ 自动从阿里云凭证文件读取)

[//]: # (- ✅ 不在代码中硬编码密钥)

[//]: # ()
[//]: # (### 2. 频率限制)

[//]: # (- ✅ 60秒内只能发送一次)

[//]: # (- ✅ Redis记录发送时间)

[//]: # (- ✅ 防止恶意刷短信)

[//]: # ()
[//]: # (### 3. 验证码管理)

[//]: # (- ✅ 5分钟自动过期)

[//]: # (- ✅ 使用后自动删除)

[//]: # (- ✅ 发送失败自动清理)

[//]: # ()
[//]: # (### 4. 错误处理)

[//]: # (- ✅ 完整的错误日志)

[//]: # (- ✅ 友好的错误提示)

[//]: # (- ✅ 异常情况回滚)

[//]: # ()
[//]: # (---)

[//]: # ()
[//]: # (## 📊 对比分析)

[//]: # ()
[//]: # (### 腾讯云 vs 阿里云)

[//]: # ()
[//]: # (| 特性 | 腾讯云 SMS | 阿里云 Dypnsapi |)

[//]: # (|------|-----------|----------------|)

[//]: # (| SDK复杂度 | 中等 | 较高 |)

[//]: # (| 错误处理 | 简单 | 详细 |)

[//]: # (| 文档质量 | 良好 | 优秀 |)

[//]: # (| 价格 | 0.045元/条 | 0.045元/条 |)

[//]: # (| 到达率 | 99%+ | 99%+ |)

[//]: # (| 国际支持 | 支持 | 支持 |)

[//]: # (| 凭证管理 | 手动配置 | 自动读取 |)

[//]: # ()
[//]: # (### 迁移优势)

[//]: # ()
[//]: # (✅ **更安全的凭证管理**)

[//]: # (- 支持多种凭证配置方式)

[//]: # (- 自动从环境变量和配置文件读取)

[//]: # ()
[//]: # (✅ **更详细的错误信息**)

[//]: # (- 提供诊断建议)

[//]: # (- 便于问题排查)

[//]: # ()
[//]: # (✅ **更灵活的配置**)

[//]: # (- 支持多种初始化方式)

[//]: # (- 适应不同部署环境)

[//]: # ()
[//]: # (---)

[//]: # ()
[//]: # (## 📝 环境变量说明)

[//]: # ()
[//]: # (### 必需配置)

[//]: # ()
[//]: # (```bash)

[//]: # (# 阿里云AccessKey ID（必填）)

[//]: # (ALIBABA_CLOUD_ACCESS_KEY_ID=LTAI5tXXXXXXXXXXXXXX)

[//]: # ()
[//]: # (# 阿里云AccessKey Secret（必填）)

[//]: # (ALIBABA_CLOUD_ACCESS_KEY_SECRET=xxxxxxxxxxxxxxxxxxxxx)

[//]: # ()
[//]: # (# 短信签名（必填）)

[//]: # (ALIYUN_SMS_SIGN_NAME=速通互联验证码)

[//]: # ()
[//]: # (# 短信模板CODE（必填）)

[//]: # (ALIYUN_SMS_TEMPLATE_CODE=100001)

[//]: # (```)

[//]: # ()
[//]: # (### 可选配置)

[//]: # ()
[//]: # (```bash)

[//]: # (# Redis配置（用于验证码存储）)

[//]: # (REDIS_HOST=localhost)

[//]: # (REDIS_PORT=6379)

[//]: # (REDIS_PASSWORD=)

[//]: # (REDIS_DB=0)

[//]: # ()
[//]: # (# 数据库配置（用于用户验证）)

[//]: # (DB_HOST=localhost)

[//]: # (DB_PORT=3306)

[//]: # (DB_USER=root)

[//]: # (DB_PASSWORD=password)

[//]: # (DB_NAME=elysia)

[//]: # (```)

[//]: # ()
[//]: # (---)

[//]: # ()
[//]: # (## 🧪 测试用例)

[//]: # ()
[//]: # (### 1. 正常发送测试)

[//]: # ()
[//]: # (```bash)

[//]: # (# 学生注册验证码)

[//]: # (curl -X POST http://localhost:8001/api/student/auth/send-register-code \)

[//]: # (  -H "Content-Type: application/json" \)

[//]: # (  -d '{"phone_number": "18873197041"}')

[//]: # ()
[//]: # (# 预期响应)

[//]: # ({)

[//]: # (  "code": 200,)

[//]: # (  "message": "验证码发送成功",)

[//]: # (  "data": null)

[//]: # (})

[//]: # (```)

[//]: # ()
[//]: # (### 2. 频率限制测试)

[//]: # ()
[//]: # (```bash)

[//]: # (# 连续发送两次（第二次应该失败）)

[//]: # (curl -X POST http://localhost:8001/api/student/auth/send-register-code \)

[//]: # (  -H "Content-Type: application/json" \)

[//]: # (  -d '{"phone_number": "18873197041"}')

[//]: # ()
[//]: # (# 预期响应)

[//]: # ({)

[//]: # (  "code": 400,)

[//]: # (  "message": "发送过于频繁，请XX秒后再试",)

[//]: # (  "data": null)

[//]: # (})

[//]: # (```)

[//]: # ()
[//]: # (### 3. 手机号格式测试)

[//]: # ()
[//]: # (```bash)

[//]: # (# 错误的手机号格式)

[//]: # (curl -X POST http://localhost:8001/api/student/auth/send-register-code \)

[//]: # (  -H "Content-Type: application/json" \)

[//]: # (  -d '{"phone_number": "123"}')

[//]: # ()
[//]: # (# 预期响应)

[//]: # ({)

[//]: # (  "code": 400,)

[//]: # (  "message": "手机号格式不正确",)

[//]: # (  "data": null)

[//]: # (})

[//]: # (```)

[//]: # ()
[//]: # (### 4. 用户存在性测试)

[//]: # ()
[//]: # (```bash)

[//]: # (# 注册时手机号已存在)

[//]: # (curl -X POST http://localhost:8001/api/student/auth/send-register-code \)

[//]: # (  -H "Content-Type: application/json" \)

[//]: # (  -d '{"phone_number": "已注册的手机号"}')

[//]: # ()
[//]: # (# 预期响应)

[//]: # ({)

[//]: # (  "code": 400,)

[//]: # (  "message": "该手机号已注册",)

[//]: # (  "data": null)

[//]: # (})

[//]: # (```)

[//]: # ()
[//]: # (---)

[//]: # ()
[//]: # (## 🐛 常见问题)

[//]: # ()
[//]: # (### Q1: 依赖安装失败)

[//]: # (```bash)

[//]: # (# 清理缓存后重试)

[//]: # (go clean -modcache)

[//]: # (go mod tidy)

[//]: # (```)

[//]: # ()
[//]: # (### Q2: 短信发送失败)

[//]: # (检查以下配置：)

[//]: # (- AccessKey 是否正确)

[//]: # (- 用户是否有权限)

[//]: # (- 签名和模板是否审核通过)

[//]: # (- 账户余额是否充足)

[//]: # ()
[//]: # (### Q3: 验证码收不到)

[//]: # (可能原因：)

[//]: # (- 手机号格式错误)

[//]: # (- 短信被运营商拦截)

[//]: # (- 模板参数不匹配)

[//]: # (- 签名未审核通过)

[//]: # ()
[//]: # (### Q4: 编译错误)

[//]: # (```bash)

[//]: # (# 确保Go版本 >= 1.21)

[//]: # (go version)

[//]: # ()
[//]: # (# 重新下载依赖)

[//]: # (rm -rf go.sum)

[//]: # (go mod tidy)

[//]: # (```)

[//]: # ()
[//]: # (---)

[//]: # ()
[//]: # (## 📚 相关文档)

[//]: # ()
[//]: # (### 项目文档)

[//]: # (- [ALIYUN_SMS_MIGRATION.md]&#40;./ALIYUN_SMS_MIGRATION.md&#41; - 详细迁移指南)

[//]: # (- [README.md]&#40;./README.md&#41; - 项目说明)

[//]: # (- [.env.example]&#40;./.env.example&#41; - 环境变量示例)

[//]: # ()
[//]: # (### 阿里云文档)

[//]: # (- [号码认证服务文档]&#40;https://help.aliyun.com/product/75010.html&#41;)

[//]: # (- [Go SDK文档]&#40;https://help.aliyun.com/document_detail/378661.html&#41;)

[//]: # (- [API参考]&#40;https://api.aliyun.com/product/Dypnsapi&#41;)

[//]: # (- [凭证配置]&#40;https://help.aliyun.com/document_detail/378661.html&#41;)

[//]: # ()
[//]: # (### 脚本文件)

[//]: # (- `install_aliyun_sms.sh` - 依赖安装脚本)

[//]: # (- `test_aliyun_sms.sh` - 自动化测试脚本)

[//]: # ()
[//]: # (---)

[//]: # ()
[//]: # (## ✅ 验收清单)

[//]: # ()
[//]: # (### 代码层面)

[//]: # (- [x] 移除腾讯云SDK依赖)

[//]: # (- [x] 添加阿里云SDK依赖)

[//]: # (- [x] 实现 AliyunSMSClient)

[//]: # (- [x] 更新 SMSService)

[//]: # (- [x] 更新环境变量配置)

[//]: # (- [x] 添加错误处理)

[//]: # (- [x] 添加日志记录)

[//]: # ()
[//]: # (### 文档层面)

[//]: # (- [x] 创建迁移指南)

[//]: # (- [x] 创建安装脚本)

[//]: # (- [x] 创建测试脚本)

[//]: # (- [x] 创建总结文档)

[//]: # (- [x] 更新环境变量示例)

[//]: # ()
[//]: # (### 测试层面)

[//]: # (- [ ] 安装依赖包)

[//]: # (- [ ] 配置阿里云凭证)

[//]: # (- [ ] 测试学生注册验证码)

[//]: # (- [ ] 测试学生登录验证码)

[//]: # (- [ ] 测试教师注册验证码)

[//]: # (- [ ] 测试教师登录验证码)

[//]: # (- [ ] 测试管理员登录验证码)

[//]: # (- [ ] 测试频率限制)

[//]: # (- [ ] 测试错误处理)

[//]: # (- [ ] 部署到生产环境)

[//]: # ()
[//]: # (---)

[//]: # ()
[//]: # (## 🎯 下一步操作)

[//]: # ()
[//]: # (### 1. 立即执行)

[//]: # (```bash)

[//]: # (# 1. 安装依赖)

[//]: # (chmod +x install_aliyun_sms.sh)

[//]: # (./install_aliyun_sms.sh)

[//]: # ()
[//]: # (# 2. 配置环境变量)

[//]: # (vim .env)

[//]: # (# 添加阿里云凭证)

[//]: # ()
[//]: # (# 3. 编译运行)

[//]: # (go build -o elysia-backend)

[//]: # (./elysia-backend)

[//]: # ()
[//]: # (# 4. 测试验证)

[//]: # (chmod +x test_aliyun_sms.sh)

[//]: # (./test_aliyun_sms.sh)

[//]: # (```)

[//]: # ()
[//]: # (### 2. 生产部署前)

[//]: # (- [ ] 在测试环境充分测试)

[//]: # (- [ ] 配置生产环境凭证)

[//]: # (- [ ] 设置监控告警)

[//]: # (- [ ] 准备回滚方案)

[//]: # (- [ ] 通知相关人员)

[//]: # ()
[//]: # (### 3. 上线后)

[//]: # (- [ ] 监控短信发送成功率)

[//]: # (- [ ] 检查错误日志)

[//]: # (- [ ] 收集用户反馈)

[//]: # (- [ ] 优化配置参数)

[//]: # ()
[//]: # (---)

[//]: # ()
[//]: # (## 🎉 总结)

[//]: # ()
[//]: # (✅ **迁移完成！**)

[//]: # ()
[//]: # (本次迁移成功将短信服务从腾讯云切换到阿里云，实现了：)

[//]: # ()
[//]: # (1. **代码层面**：完整替换短信客户端，保持业务逻辑不变)

[//]: # (2. **配置层面**：更新环境变量，支持多种凭证管理方式)

[//]: # (3. **文档层面**：提供详细的迁移指南和使用说明)

[//]: # (4. **工具层面**：提供自动化安装和测试脚本)

[//]: # ()
[//]: # (**所有三端（学生、教师、管理员）的短信发送功能都已更新为阿里云实现！**)

[//]: # ()
[//]: # (如有任何问题，请参考 [ALIYUN_SMS_MIGRATION.md]&#40;./ALIYUN_SMS_MIGRATION.md&#41; 或联系技术支持。)

[//]: # ()
[//]: # (---)

[//]: # ()
[//]: # (**文档创建时间**: 2026-02-06  )

[//]: # (**最后更新时间**: 2026-02-06  )

[//]: # (**版本**: 1.0.0)
